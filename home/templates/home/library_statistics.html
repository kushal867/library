{% extends 'base.html' %}
{% load static %}

{% block title %}Library Statistics - Library MS{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-info">
        <h1><i class="fas fa-chart-pie"></i> Library Insights</h1>
        <p>Comprehensive analytics and inventory overview</p>
    </div>
    <div class="header-actions">
        <button class="btn btn-secondary" onclick="window.print()"><i class="fas fa-print"></i> Report</button>
        <a href="{% url 'export_issued_books' %}" class="btn btn-primary"><i class="fas fa-file-export"></i> Export CSV</a>
    </div>
</div>

<div class="stats-dashboard">
    <div class="main-stats">
        <div class="stat-card glass-effect">
            <div class="stat-icon purple"><i class="fas fa-book"></i></div>
            <div class="stat-content">
                <h3>{{ total_books }}</h3>
                <p>Unique Titles</p>
            </div>
        </div>
        <div class="stat-card glass-effect">
            <div class="stat-icon blue"><i class="fas fa-copy"></i></div>
            <div class="stat-content">
                <h3>{{ total_copies }}</h3>
                <p>Total Inventory</p>
            </div>
        </div>
        <div class="stat-card glass-effect">
            <div class="stat-icon orange"><i class="fas fa-hand-holding"></i></div>
            <div class="stat-content">
                <h3>{{ currently_issued }}</h3>
                <p>Books on Loan</p>
            </div>
        </div>
        <div class="stat-card glass-effect">
            <div class="stat-icon red"><i class="fas fa-exclamation-circle"></i></div>
            <div class="stat-content">
                <h3>{{ overdue_count }}</h3>
                <p>Overdue Items</p>
            </div>
        </div>
    </div>

    <div class="charts-row">
        <div class="chart-container glass-effect">
            <h3>Category Distribution</h3>
            <canvas id="categoryChart"></canvas>
        </div>
        <div class="chart-container glass-effect">
            <h3>Inventory Status</h3>
            <canvas id="statusChart"></canvas>
        </div>
    </div>

    <div class="tables-row">
        <div class="table-card glass-effect">
            <h3>Popular Books</h3>
            <table class="modern-table-sm">
                <thead>
                    <tr><th>Book</th><th>Issues</th></tr>
                </thead>
                <tbody>
                    {% for book in popular_books %}
                    <tr><td>{{ book.name }}</td><td>{{ book.issue_count }}</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="table-card glass-effect">
            <h3>Top Borrowers</h3>
            <table class="modern-table-sm">
                <thead>
                    <tr><th>Student</th><th>Books</th></tr>
                </thead>
                <tbody>
                    {% for student in active_borrowers %}
                    <tr><td>{{ student.user.username }}</td><td>{{ student.borrow_count }}</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{{ category_stats_json|json_script:"category-data" }}
{{ status_data_json|json_script:"status-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categoryData = JSON.parse(document.getElementById('category-data').textContent);
    const statusData = JSON.parse(document.getElementById('status-data').textContent);

    // Category Chart
    const catCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(catCtx, {
        type: 'doughnut',
        data: {
            labels: categoryData.map(item => item.name),
            datasets: [{
                data: categoryData.map(item => item.book_count),
                backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899']
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } }
        }
    });

    // Status Chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'pie',
        data: {
            labels: ['Available', 'Issued'],
            datasets: [{
                data: [statusData.available, statusData.issued],
                backgroundColor: ['#10b981', '#f59e0b']
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } }
        }
    });
});
</script>

<style>
.stats-dashboard { margin-top: 2rem; display: flex; flex-direction: column; gap: 2rem; }
.main-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; }
.stat-card { display: flex; align-items: center; gap: 1.5rem; padding: 1.5rem; border-radius: 15px; }
.stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; }
.stat-icon.purple { background: #8b5cf6; }
.stat-icon.blue { background: #3b82f6; }
.stat-icon.orange { background: #f59e0b; }
.stat-icon.red { background: #ef4444; }
.charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
.chart-container { padding: 2rem; border-radius: 20px; }
.chart-container h3 { margin-bottom: 2rem; text-align: center; }
.tables-row { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
.table-card { padding: 1.5rem; border-radius: 20px; }
.modern-table-sm { width: 100%; border-collapse: collapse; margin-top: 1rem; }
.modern-table-sm th { text-align: left; font-size: 0.8rem; color: var(--text-muted); padding: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
.modern-table-sm td { padding: 0.8rem 0.5rem; font-size: 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
@media print {
    .btn, .navbar, .site-footer { display: none !important; }
    .glass-effect { border: 1px solid #ccc !important; box-shadow: none !important; color: black !important; }
}
</style>
{% endblock %}
