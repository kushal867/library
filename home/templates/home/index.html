{% extends 'base.html' %}

{% block title %}Dashboard - Library MS{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Welcome back, {{ request.user.username }}! ðŸ‘‹</h1>
    <p>Manage your library collection with style and efficiency</p>
</div>

<div class="stats-grid">
    <div class="card-stat stagger-item">
        <h3>Total Books</h3>
        <p><span class="counter" data-target="{{ total_books }}">0</span></p>
    </div>
    <div class="card-stat stagger-item">
        <h3>Total Copies</h3>
        <p><span class="counter" data-target="{{ total_quantity }}">0</span></p>
    </div>
    <div class="card-stat stagger-item">
        <h3>Issued Books</h3>
        <p><span class="counter" data-target="{{ total_issued }}">0</span></p>
    </div>
    <div class="card-stat stagger-item">
        <h3>Available Copies</h3>
        <p><span class="counter" data-target="{{ total_available }}">0</span></p>
    </div>
</div>

<!-- Search and Filter Bar -->
<div class="search-filter-bar">
    <div class="search-box">
        <i class="fas fa-search input-icon"></i>
        <input 
            type="text" 
            id="searchInput" 
            placeholder="Search books by title, author, or ISBN..."
            oninput="filterBooks()">
    </div>
    <select class="filter-select" id="categoryFilter" onchange="filterBooks()">
        <option value="">All Categories</option>
        <option value="Fiction">Fiction</option>
        <option value="Non-Fiction">Non-Fiction</option>
        <option value="Science">Science</option>
        <option value="History">History</option>
        <option value="Biography">Biography</option>
        <option value="Technology">Technology</option>
        <option value="Philosophy">Philosophy</option>
        <option value="Literature">Literature</option>
    </select>
    <select class="filter-select" id="sortSelect" onchange="sortBooks()">
        <option value="recent">Most Recent</option>
        <option value="title">Title (A-Z)</option>
        <option value="author">Author (A-Z)</option>
    </select>
</div>

<!-- View Toggle -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h2><i class="fas fa-book-open"></i> Your Books</h2>
    <div class="view-toggle">
        <div class="view-btn active" onclick="switchView('grid')" id="gridViewBtn">
            <i class="fas fa-th-large"></i> Grid
        </div>
        <div class="view-btn" onclick="switchView('list')" id="listViewBtn">
            <i class="fas fa-list"></i> List
        </div>
    </div>
</div>

{% if books %} 
<!-- Grid View -->
<div class="books-grid" id="booksGrid">
    {% for book in books %}
    <div class="book-card card-3d stagger-item" data-title="{{ book.name|lower }}" data-author="{{ book.author|lower }}" data-isbn="{{ book.isbn }}" data-category="{{ book.category }}">
        <div class="book-cover">
            <i class="fas fa-book"></i>
        </div>
        <div class="book-info">
            <div class="book-title">{{ book.name }}</div>
            <div class="book-author">
                <i class="fas fa-user-edit"></i>
                {{ book.author }}
            </div>
            <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                <i class="fas fa-barcode"></i> ISBN: {{ book.isbn }}
            </div>
            <span class="badge">{{ book.category }}</span>
            
            <div class="book-meta">
                <div class="book-availability {% if book.is_available %}available{% else %}unavailable{% endif %}">
                    <i class="fas fa-{% if book.is_available %}check-circle{% else %}times-circle{% endif %}"></i>
                    {% if book.is_available %}
                        {{ book.available_quantity }} Available
                    {% else %}
                        Not Available
                    {% endif %}
                </div>
                <div class="book-actions">
                    <a href="javascript:void(0)" 
                       class="icon-btn delete-btn ripple" 
                       onclick="confirmDelete({{ book.id }}, '{{ book.name|escapejs }}')"
                       title="Delete Book">
                        <i class="fas fa-trash"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>


<!-- List View (Table) -->
<div class="table-container" id="booksTable" style="display: none;">
    <table>
        <thead>
            <tr>
                <th>Title</th>
                <th>Author</th>
                <th>ISBN</th>
                <th>Category</th>
                <th>Quantity</th>
                <th>Available</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="booksTableBody">
            {% for book in books %}
            <tr class="stagger-item" data-title="{{ book.name|lower }}" data-author="{{ book.author|lower }}" data-isbn="{{ book.isbn }}" data-category="{{ book.category }}">
                <td><strong>{{ book.name }}</strong></td>
                <td>{{ book.author }}</td>
                <td>{{ book.isbn }}</td>
                <td><span class="badge">{{ book.category }}</span></td>
                <td>{{ book.quantity }}</td>
                <td>
                    {% if book.is_available %}
                        <span style="color: #4ade80;">âœ“ {{ book.available_quantity }}</span>
                    {% else %}
                        <span style="color: #f87171;">âœ— 0</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        <a href="javascript:void(0)" class="btn btn-sm btn-danger ripple" onclick="confirmDelete({{ book.id }}, '{{ book.name|escapejs }}')">
                            <i class="fas fa-trash"></i> Delete
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="empty-state">
    <i class="fas fa-book-open"></i>
    <h3>No books in your library yet</h3>
    <p>Start building your collection by adding your first book</p>
    <a href="{% url 'add_book' %}" class="btn">
        <i class="fas fa-plus-circle"></i> Add Your First Book
    </a>
</div>
{% endif %}

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteModal">
    <div class="modal">
        <h3><i class="fas fa-exclamation-triangle"></i> Confirm Deletion</h3>
        <p id="deleteMessage">Are you sure you want to delete this book?</p>
        <div class="modal-buttons">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <a href="#" id="confirmDeleteBtn" class="btn btn-danger">
                <i class="fas fa-trash"></i> Delete
            </a>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // View Switching
    let currentView = 'grid';
    
    function switchView(view) {
        currentView = view;
        const gridView = document.getElementById('booksGrid');
        const listView = document.getElementById('booksTable');
        const gridBtn = document.getElementById('gridViewBtn');
        const listBtn = document.getElementById('listViewBtn');
        
        if (view === 'grid') {
            gridView.style.display = 'grid';
            listView.style.display = 'none';
            gridBtn.classList.add('active');
            listBtn.classList.remove('active');
        } else {
            gridView.style.display = 'none';
            listView.style.display = 'block';
            gridBtn.classList.remove('active');
            listBtn.classList.add('active');
        }
        
        localStorage.setItem('preferredView', view);
    }
    
    // Load preferred view
    window.addEventListener('DOMContentLoaded', function() {
        const preferredView = localStorage.getItem('preferredView') || 'grid';
        switchView(preferredView);
    });
    
    // Search and Filter Functionality
    function filterBooks() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const categoryFilter = document.getElementById('categoryFilter').value;
        
        const gridCards = document.querySelectorAll('.book-card');
        const tableRows = document.querySelectorAll('#booksTableBody tr');
        
        // Filter grid cards
        gridCards.forEach(card => {
            const title = card.dataset.title;
            const author = card.dataset.author;
            const isbn = card.dataset.isbn;
            const category = card.dataset.category;
            
            const matchesSearch = title.includes(searchTerm) || 
                                author.includes(searchTerm) || 
                                isbn.includes(searchTerm);
            const matchesCategory = !categoryFilter || category === categoryFilter;
            
            if (matchesSearch && matchesCategory) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
        
        // Filter table rows
        tableRows.forEach(row => {
            const title = row.dataset.title;
            const author = row.dataset.author;
            const isbn = row.dataset.isbn;
            const category = row.dataset.category;
            
            const matchesSearch = title.includes(searchTerm) || 
                                author.includes(searchTerm) || 
                                isbn.includes(searchTerm);
            const matchesCategory = !categoryFilter || category === categoryFilter;
            
            if (matchesSearch && matchesCategory) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    // Sort Books
    function sortBooks() {
        const sortBy = document.getElementById('sortSelect').value;
        
        // Sort grid
        const gridContainer = document.getElementById('booksGrid');
        const gridCards = Array.from(gridContainer.querySelectorAll('.book-card'));
        
        gridCards.sort((a, b) => {
            let aVal, bVal;
            
            if (sortBy === 'title') {
                aVal = a.dataset.title;
                bVal = b.dataset.title;
            } else if (sortBy === 'author') {
                aVal = a.dataset.author;
                bVal = b.dataset.author;
            } else {
                return 0; // Keep original order for 'recent'
            }
            
            return aVal.localeCompare(bVal);
        });
        
        gridCards.forEach(card => gridContainer.appendChild(card));
        
        // Sort table
        const tbody = document.getElementById('booksTableBody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
            let aVal, bVal;
            
            if (sortBy === 'title') {
                aVal = a.dataset.title;
                bVal = b.dataset.title;
            } else if (sortBy === 'author') {
                aVal = a.dataset.author;
                bVal = b.dataset.author;
            } else {
                return 0;
            }
            
            return aVal.localeCompare(bVal);
        });
        
        rows.forEach(row => tbody.appendChild(row));
    }
    
    // Delete Confirmation
    function confirmDelete(bookId, bookName) {
        const modal = document.getElementById('deleteModal');
        const message = document.getElementById('deleteMessage');
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        
        message.textContent = `Are you sure you want to delete "${bookName}"? This action cannot be undone.`;
        confirmBtn.href = `/home/delete_book/${bookId}/`;
        
        modal.classList.add('active');
    }
    
    function closeDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.classList.remove('active');
    }
    
    // Close modal on overlay click
    document.getElementById('deleteModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDeleteModal();
        }
    });
    
    // Show success message if book added/deleted
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('added') === 'true') {
        showToast('Book added successfully!', 'success');
    }
    if (urlParams.get('deleted') === 'true') {
        showToast('Book deleted successfully!', 'success');
    }

    // Animated Counter for Statistics
    function animateCounters() {
        const counters = document.querySelectorAll('.counter');
        
        counters.forEach(counter => {
            const target = parseInt(counter.getAttribute('data-target'));
            const duration = 2000; // 2 seconds
            const increment = target / (duration / 16); // 60fps
            let current = 0;
            
            const updateCounter = () => {
                current += increment;
                if (current < target) {
                    counter.textContent = Math.floor(current);
                    requestAnimationFrame(updateCounter);
                } else {
                    counter.textContent = target;
                }
            };
            
            updateCounter();
        });
    }
    
    // Trigger counter animation on page load
    window.addEventListener('load', function() {
        setTimeout(animateCounters, 300);
    });
</script>

<style>
    .badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(240, 147, 251, 0.2));
        border: 1px solid rgba(240, 147, 251, 0.3);
        color: var(--accent);
        display: inline-block;
    }
</style>
{% endblock %}

{% endblock %}
