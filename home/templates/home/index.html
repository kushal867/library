{% extends 'base.html' %}

{% block title %}Dashboard - Library MS{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Welcome back, {{ request.user.username }}! ðŸ‘‹</h1>
    <p>Manage your library collection with style and efficiency</p>
</div>

<div class="stats-grid">
    <div class="card-stat">
        <h3>Total Books</h3>
        <p>{{ total_books }}</p>
    </div>
    <div class="card-stat">
        <h3>Total Copies</h3>
        <p>{{ total_quantity }}</p>
    </div>
    <div class="card-stat">
        <h3>Issued Books</h3>
        <p>{{ total_issued }}</p>
    </div>
    <div class="card-stat">
        <h3>Available Copies</h3>
        <p>{{ total_available }}</p>
    </div>
</div>

<!-- Search and Filter Bar -->
<div class="search-filter-bar">
    <div class="search-box">
        <i class="fas fa-search input-icon"></i>
        <input 
            type="text" 
            id="searchInput" 
            placeholder="Search books by title, author, or ISBN..."
            oninput="filterBooks()">
    </div>
    <select class="filter-select" id="categoryFilter" onchange="filterBooks()">
        <option value="">All Categories</option>
        <option value="Fiction">Fiction</option>
        <option value="Non-Fiction">Non-Fiction</option>
        <option value="Science">Science</option>
        <option value="History">History</option>
        <option value="Biography">Biography</option>
        <option value="Technology">Technology</option>
        <option value="Philosophy">Philosophy</option>
        <option value="Literature">Literature</option>
    </select>
    <select class="filter-select" id="sortSelect" onchange="sortBooks()">
        <option value="recent">Most Recent</option>
        <option value="title">Title (A-Z)</option>
        <option value="author">Author (A-Z)</option>
    </select>
</div>

<h2><i class="fas fa-book-open"></i> Your Books</h2>

{% if books %}
<div class="table-container">
    <table id="booksTable">
        <thead>
            <tr>
                <th>Title</th>
                <th>Author</th>
                <th>ISBN</th>
                <th>Category</th>
                <th>Quantity</th>
                <th>Available</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="booksTableBody">
            {% for book in books %}
            <tr data-title="{{ book.name|lower }}" data-author="{{ book.author|lower }}" data-isbn="{{ book.isbn }}" data-category="{{ book.category }}">
                <td><strong>{{ book.name }}</strong></td>
                <td>{{ book.author }}</td>
                <td>{{ book.isbn }}</td>
                <td><span class="badge">{{ book.category }}</span></td>
                <td>{{ book.quantity }}</td>
                <td>
                    {% if book.is_available %}
                        <span style="color: #4ade80;">âœ“ {{ book.available_quantity }}</span>
                    {% else %}
                        <span style="color: #f87171;">âœ— 0</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        <a href="javascript:void(0)" class="btn btn-sm btn-danger" onclick="confirmDelete({{ book.id }}, '{{ book.name|escapejs }}')">
                            <i class="fas fa-trash"></i> Delete
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="empty-state">
    <i class="fas fa-book-open"></i>
    <h3>No books in your library yet</h3>
    <p>Start building your collection by adding your first book</p>
    <a href="{% url 'add_book' %}" class="btn">
        <i class="fas fa-plus-circle"></i> Add Your First Book
    </a>
</div>
{% endif %}

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteModal">
    <div class="modal">
        <h3><i class="fas fa-exclamation-triangle"></i> Confirm Deletion</h3>
        <p id="deleteMessage">Are you sure you want to delete this book?</p>
        <div class="modal-buttons">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <a href="#" id="confirmDeleteBtn" class="btn btn-danger">
                <i class="fas fa-trash"></i> Delete
            </a>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // Search and Filter Functionality
    function filterBooks() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const categoryFilter = document.getElementById('categoryFilter').value;
        const rows = document.querySelectorAll('#booksTableBody tr');
        
        rows.forEach(row => {
            const title = row.dataset.title;
            const author = row.dataset.author;
            const isbn = row.dataset.isbn;
            const category = row.dataset.category;
            
            const matchesSearch = title.includes(searchTerm) || 
                                author.includes(searchTerm) || 
                                isbn.includes(searchTerm);
            const matchesCategory = !categoryFilter || category === categoryFilter;
            
            if (matchesSearch && matchesCategory) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    // Sort Books
    function sortBooks() {
        const sortBy = document.getElementById('sortSelect').value;
        const tbody = document.getElementById('booksTableBody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
            let aVal, bVal;
            
            if (sortBy === 'title') {
                aVal = a.dataset.title;
                bVal = b.dataset.title;
            } else if (sortBy === 'author') {
                aVal = a.dataset.author;
                bVal = b.dataset.author;
            } else {
                return 0; // Keep original order for 'recent'
            }
            
            return aVal.localeCompare(bVal);
        });
        
        rows.forEach(row => tbody.appendChild(row));
    }
    
    // Delete Confirmation
    function confirmDelete(bookId, bookName) {
        const modal = document.getElementById('deleteModal');
        const message = document.getElementById('deleteMessage');
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        
        message.textContent = `Are you sure you want to delete "${bookName}"? This action cannot be undone.`;
        confirmBtn.href = `/home/delete_book/${bookId}/`;
        
        modal.classList.add('active');
    }
    
    function closeDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.classList.remove('active');
    }
    
    // Close modal on overlay click
    document.getElementById('deleteModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDeleteModal();
        }
    });
    
    // Edit Book (placeholder - can be implemented with a modal form)
    function editBook(bookId) {
        showToast('Edit functionality coming soon!', 'info');
    }
    
    // Show success message if book added/deleted
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('added') === 'true') {
        showToast('Book added successfully!', 'success');
    }
    if (urlParams.get('deleted') === 'true') {
        showToast('Book deleted successfully!', 'success');
    }
</script>

<style>
    .badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(240, 147, 251, 0.2));
        border: 1px solid rgba(240, 147, 251, 0.3);
        color: var(--accent);
        display: inline-block;
    }
</style>
{% endblock %}

{% endblock %}

