{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Library MS{% endblock %}

{% block content %}
<div class="dashboard-hero premium-hero">
    <div class="hero-content">
        <div class="hero-badge">
            <i class="fas fa-sparkles"></i> <span>Welcome back, {{ request.user.get_full_name|default:request.user.username }}</span>
        </div>
        <h1>Elevate Your <span>Knowledge</span></h1>
        <p>Explore thousands of resources, track your reading journey, and discover your next favorite book with our intelligent management system.</p>
        <div class="hero-actions">
            <a href="{% url 'issue_book' %}" class="btn btn-primary ripple-glow">
                <i class="fas fa-hand-holding"></i> Issue a Book
            </a>
            {% if user.is_staff %}
            <a href="{% url 'teacher_list' %}" class="btn btn-glass ripple">
                <i class="fas fa-chalkboard-teacher"></i> Faculty
            </a>
            <a href="{% url 'subject_list' %}" class="btn btn-glass ripple">
                <i class="fas fa-book-open"></i> Curriculum
            </a>
            {% endif %}
        </div>
    </div>
    <div class="hero-visual">
        <div class="hero-card-stack">
            <div class="hero-card card-1"><i class="fas fa-book-medical"></i></div>
            <div class="hero-card card-2"><i class="fas fa-bookmark"></i></div>
            <div class="hero-card card-3"><i class="fas fa-star"></i></div>
        </div>
        <div class="hero-glow"></div>
    </div>
</div>

<!-- Stats -->
<div class="stats-container">
    <div class="stat-card glass-effect">
        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%);">
            <i class="fas fa-book"></i>
        </div>
        <div class="stat-info">
            <h3 class="counter" data-target="{{ total_books }}">0</h3>
            <p>Book Titles</p>
        </div>
    </div>
    <div class="stat-card glass-effect">
        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">
            <i class="fas fa-layer-group"></i>
        </div>
        <div class="stat-info">
            <h3 class="counter" data-target="{{ total_quantity }}">0</h3>
            <p>Total Copies</p>
        </div>
    </div>
    <div class="stat-card glass-effect">
        <div class="stat-icon" style="background: linear-gradient(135deg, #059669 0%, #14b8a6 100%);">
            <i class="fas fa-hand-holding"></i>
        </div>
        <div class="stat-info">
            <h3 class="counter" data-target="{{ total_issued }}">0</h3>
            <p>Issued Books</p>
        </div>
    </div>
    <div class="stat-card glass-effect">
        <div class="stat-icon" style="background: linear-gradient(135deg, #4ade80 0%, #10b981 100%);">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-info">
            <h3 class="counter" data-target="{{ total_available }}">0</h3>
            <p>Available Now</p>
        </div>
    </div>
</div>

<!-- Featured Sections -->
<div class="featured-sections">
    <div class="section-column">
        <div class="section-header">
            <h3><i class="fas fa-history"></i> Newly Published</h3>
            <a href="?sort=-date_added" class="view-all">See All <i class="fas fa-arrow-right"></i></a>
        </div>
        <div class="mini-grid">
            {% for book in recent_books %}
            <div class="compact-book-card" data-url="{% url 'book_detail' book.id %}" onclick="window.location.href=this.dataset.url">
                <div class="compact-cover">
{% if book.cover_image %}
                        <img src="{{ book.cover_image.url }}" alt="{{ book.name }}">
                    {% else %}
                        <div class="placeholder-cover"><i class="fas fa-book"></i></div>
                    {% endif %}
                </div>
                <div class="compact-info">
                    <h4>{{ book.name|truncatechars:25 }}</h4>
                    <p>{{ book.author|truncatechars:20 }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="section-column">
        <div class="section-header">
            <h3><i class="fas fa-fire"></i> Reader's Favorites</h3>
            <a href="?sort=popular" class="view-all">See All <i class="fas fa-arrow-right"></i></a>
        </div>
        <div class="mini-grid">
            {% for book in popular_books %}
            <div class="compact-book-card" data-url="{% url 'book_detail' book.id %}" onclick="window.location.href=this.dataset.url">
                <div class="compact-cover">
{% if book.cover_image %}
                        <img src="{{ book.cover_image.url }}" alt="{{ book.name }}">
                    {% else %}
                        <div class="placeholder-cover"><i class="fas fa-book"></i></div>
                    {% endif %}
                </div>
                <div class="compact-info">
                    <h4>{{ book.name|truncatechars:25 }}</h4>
                    <p>{{ book.author|truncatechars:20 }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Main Collection -->
<div id="browse-section" class="main-collection-header">
    <h2><i class="fas fa-library"></i> Browse Collection</h2>
    <div class="collection-controls">
        <div class="view-toggles">
            <button class="view-btn active" id="gridViewBtn" onclick="switchView('grid')" title="Grid View">
                <i class="fas fa-th-large"></i>
            </button>
            <button class="view-btn" id="listViewBtn" onclick="switchView('list')" title="List View">
                <i class="fas fa-list"></i>
            </button>
        </div>
    </div>
</div>

<div class="search-filter-panel glass-effect">
    <form method="GET" action="{% url 'index' %}#browse-section" class="filter-form">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" name="search" placeholder="Search title, author, isbn..." value="{{ search_query }}">
        </div>
        <div class="filter-group">
            <select name="category">
                <option value="">All Categories</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}" {% if selected_category == cat.id|stringformat:"i" %}selected{% endif %}>{{ cat.name }}</option>
                {% endfor %}
            </select>
            <select name="availability">
                <option value="">All Status</option>
                <option value="available" {% if selected_availability == 'available' %}selected{% endif %}>Available</option>
                <option value="unavailable" {% if selected_availability == 'unavailable' %}selected{% endif %}>Issued</option>
            </select>
            <select name="sort">
                <option value="-date_added" {% if selected_sort == '-date_added' %}selected{% endif %}>Newest</option>
                <option value="name" {% if selected_sort == 'name' %}selected{% endif %}>Title A-Z</option>
                <option value="author" {% if selected_sort == 'author' %}selected{% endif %}>Author</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary ripple">Apply</button>
    </form>
</div>

{% if page_obj %}
<!-- GRID VIEW -->
<div class="books-grid" id="booksGrid">
    {% for book in page_obj %}
    <div class="modern-book-card">
        <div class="card-cover">
            {% if book.cover_image %}
                <img src="{{ book.cover_image.url }}" alt="{{ book.name }}">
            {% else %}
                <div class="placeholder-cover"><i class="fas fa-book"></i></div>
            {% endif %}
            <div class="availability-tag {% if book.is_available %}tag-available{% else %}tag-unavailable{% endif %}">
                {{ book.available_quantity }} left
            </div>
            <div class="card-overlay">
                <a href="{% url 'book_detail' book.id %}" class="btn-icon ripple" title="View Details">
                    <i class="fas fa-eye"></i>
                </a>
                <a href="{% url 'edit_book' book.id %}" class="btn-icon ripple" title="Edit Book">
                    <i class="fas fa-edit"></i>
                </a>
                <button class="btn-icon ripple delete-trigger" 
                        data-delete-url="{% url 'delete_book' book.id %}"
                        data-book-name="{{ book.name|escapejs }}"
                        onclick="openDeleteModal(this)"
                        title="Delete Book">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            <span class="category-badge">{{ book.category.name }}</span>
            <h4>{{ book.name }}</h4>
            <p>{{ book.author }}</p>
            <div class="card-footer">
                <span class="isbn">ISBN: {{ book.isbn }}</span>
                <span class="issues"><i class="fas fa-hand-holding"></i> {{ book.times_issued }}</span>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- LIST VIEW -->
<div class="list-view-container" id="booksTable" style="display:none">
    <table class="modern-table">
        <thead>
            <tr>
                <th>Book</th>
                <th>Details</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for book in page_obj %}
            <tr>
                <td>
                    <div class="table-book-info">
                        {% if book.cover_image %}
                            <img src="{{ book.cover_image.url }}" alt="">
                        {% else %}
                            <div class="table-placeholder"><i class="fas fa-book"></i></div>
                        {% endif %}
                        <div>
                            <strong>{{ book.name }}</strong>
                            <span>ISBN: {{ book.isbn }}</span>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="table-details">
                        <span class="badge">{{ book.category.name }}</span>
                        <span>{{ book.author }}</span>
                    </div>
                </td>
                <td>
                    <span class="status-indicator {% if book.is_available %}status-active{% else %}status-warning{% endif %}">
                        {{ book.available_quantity }} / {{ book.quantity }} Available
                    </span>
                </td>
                <td>
                    <div class="table-actions">
                        <a href="{% url 'book_detail' book.id %}" class="action-btn" title="View"><i class="fas fa-eye"></i></a>
                        <a href="{% url 'edit_book' book.id %}" class="action-btn" title="Edit"><i class="fas fa-edit"></i></a>
                        <button class="action-btn delete-trigger" 
                                data-delete-url="{% url 'delete_book' book.id %}"
                                data-book-name="{{ book.name|escapejs }}"
                                onclick="openDeleteModal(this)" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
<div class="pagination-container">
    <div class="pagination">
        {% if page_obj.has_previous %}
            <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_availability %}&availability={{ selected_availability }}{% endif %}{% if selected_sort %}&sort={{ selected_sort }}{% endif %}#browse-section" class="page-btn"><i class="fas fa-angle-double-left"></i></a>
            <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_availability %}&availability={{ selected_availability }}{% endif %}{% if selected_sort %}&sort={{ selected_sort }}{% endif %}#browse-section" class="page-btn"><i class="fas fa-angle-left"></i></a>
        {% endif %}

        <span class="page-info">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_availability %}&availability={{ selected_availability }}{% endif %}{% if selected_sort %}&sort={{ selected_sort }}{% endif %}#browse-section" class="page-btn"><i class="fas fa-angle-right"></i></a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_availability %}&availability={{ selected_availability }}{% endif %}{% if selected_sort %}&sort={{ selected_sort }}{% endif %}#browse-section" class="page-btn"><i class="fas fa-angle-double-right"></i></a>
        {% endif %}
    </div>
</div>
{% else %}
<div class="empty-state glass-effect">
    <i class="fas fa-search-minus"></i>
    <h3>No books found</h3>
    <p>Try adjusting your search or filters to find what you're looking for.</p>
    <a href="{% url 'index' %}" class="btn btn-secondary">Clear All Filters</a>
</div>
{% endif %}

<!-- DELETE MODAL -->
<div class="modal-overlay" id="deleteModal">
    <div class="modal delete-modal">
        <div class="modal-header">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Confirm Deletion</h3>
        </div>
        <div class="modal-body">
            <p id="deleteMessage"></p>
            <p class="warning-text">This action cannot be undone. All issue history for this book will be preserved, but no new copies can be issued.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
            <form method="post" id="deleteForm" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger ripple">Confirm Delete</button>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
(() => {
    const gridViewBtn = document.getElementById('gridViewBtn');
    const listViewBtn = document.getElementById('listViewBtn');
    const booksGrid = document.getElementById('booksGrid');
    const booksTable = document.getElementById('booksTable');

    /* ---------- VIEW SWITCHER ---------- */
    window.switchView = (view) => {
        localStorage.setItem('preferredLibraryView', view);
        
        if (view === 'grid') {
            booksGrid.style.display = 'grid';
            booksTable.style.display = 'none';
            gridViewBtn.classList.add('active');
            listViewBtn.classList.remove('active');
            animateStaggeredItems();
        } else {
            booksGrid.style.display = 'none';
            booksTable.style.display = 'block';
            gridViewBtn.classList.remove('active');
            listViewBtn.classList.add('active');
        }
    };

    /* ---------- STAGGERED ENTRANCE ---------- */
    function animateStaggeredItems() {
        const items = document.querySelectorAll('.modern-book-card');
        items.forEach((item, index) => {
            item.style.opacity = '0';
            item.style.transform = 'translateY(20px) rotateY(-10deg)';
            item.style.transition = `all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) ${index * 0.05}s`;
            
            setTimeout(() => {
                item.style.opacity = '1';
                item.style.transform = 'translateY(0) rotateY(0)';
            }, 50);
        });
    }

    /* ---------- COUNTER ANIMATION ---------- */
    function animateCounters() {
        document.querySelectorAll('.counter').forEach(c => {
            const target = +c.dataset.target;
            if (isNaN(target) || target === 0) {
                c.textContent = '0';
                return;
            }
            
            let current = 0;
            const duration = 2000; // 2s
            const stepTime = 20;
            const steps = duration / stepTime;
            const increment = target / steps;
            
            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    c.textContent = target;
                    clearInterval(timer);
                } else {
                    c.textContent = Math.floor(current);
                }
            }, stepTime);
        });
    }

    /* ---------- DELETE MODAL ---------- */
    const modal = document.getElementById('deleteModal');
    const msg = document.getElementById('deleteMessage');
    const form = document.getElementById('deleteForm');

    window.openDeleteModal = (btn) => {
        msg.textContent = `Are you sure you want to delete "${btn.dataset.bookName}"?`;
        form.action = btn.dataset.deleteUrl;
        modal.classList.add('active');
    };

    window.closeDeleteModal = () => {
        modal.classList.remove('active');
    };

    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeDeleteModal();
        }
    });

    /* ---------- INITIALIZATION ---------- */
    document.addEventListener('DOMContentLoaded', () => {
        const savedView = localStorage.getItem('preferredLibraryView') || 'grid';
        switchView(savedView);
        animateCounters();
        
        // 3D Mouse Movement effect (Subtle)
        document.querySelectorAll('.modern-book-card').forEach(card => {
            card.addEventListener('mousemove', (e) => {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                
                const rotateX = (y - centerY) / 10;
                const rotateY = (centerX - x) / 10;
                
                card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) translateY(-10px) scale(1.02)`;
            });
            
            card.addEventListener('mouseleave', () => {
                card.style.transform = '';
            });
        });
    });
})();
</script>
{% endblock %}
