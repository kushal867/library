{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Library MS{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Welcome back, {{ request.user.username }}!</h1>
    <p>Manage your library collection efficiently</p>
</div>

<!-- Stats -->
<div class="stats-grid">
    <div class="card-stat">
        <h3>Total Books</h3>
        <p><span class="counter" data-target="{{ total_books }}">0</span></p>
    </div>
    <div class="card-stat">
        <h3>Total Copies</h3>
        <p><span class="counter" data-target="{{ total_quantity }}">0</span></p>
    </div>
    <div class="card-stat">
        <h3>Issued Books</h3>
        <p><span class="counter" data-target="{{ total_issued }}">0</span></p>
    </div>
    <div class="card-stat">
        <h3>Available Copies</h3>
        <p><span class="counter" data-target="{{ total_available }}">0</span></p>
    </div>
</div>

<!-- Search / Filter / Sort -->
<div class="search-filter-bar">
    <input
        type="text"
        id="searchInput"
        placeholder="Search by title, author, or ISBN">
    <select id="categoryFilter">
        <option value="">All Categories</option>
        {% for c in categories %}
            <option value="{{ c|lower }}">{{ c }}</option>
        {% endfor %}
    </select>
    <select id="sortSelect">
        <option value="recent">Most Recent</option>
        <option value="title">Title (A–Z)</option>
        <option value="author">Author (A–Z)</option>
    </select>
</div>

<!-- View Toggle -->
<div class="view-toggle-bar">
    <h2>Your Books</h2>
    <div class="view-toggle">
        <button id="gridViewBtn" onclick="switchView('grid')">Grid</button>
        <button id="listViewBtn" onclick="switchView('list')">List</button>
    </div>
</div>

{% if books %}
<!-- GRID VIEW -->
<div class="books-grid" id="booksGrid">
{% for book in books %}
    <div class="book-card"
         data-title="{{ book.name|lower }}"
         data-author="{{ book.author|lower }}"
         data-isbn="{{ book.isbn }}"
         data-category="{{ book.category|lower }}">
        <div class="book-info">
            <h4>{{ book.name }}</h4>
            <p>{{ book.author }}</p>
            <p>ISBN: {{ book.isbn }}</p>
            <span class="badge">{{ book.category }}</span>

            <p class="{% if book.is_available %}available{% else %}unavailable{% endif %}">
                {% if book.is_available %}
                    {{ book.available_quantity }} Available
                {% else %}
                    Not Available
                {% endif %}
            </p>

            <button
                class="delete-btn"
                data-delete-url="{% url 'delete_book' book.id %}"
                data-book-name="{{ book.name|escapejs }}"
                onclick="openDeleteModal(this)">
                Delete
            </button>
        </div>
    </div>
{% endfor %}
</div>

<!-- LIST VIEW -->
<div id="booksTable" style="display:none">
<table>
    <thead>
        <tr>
            <th>Title</th><th>Author</th><th>ISBN</th>
            <th>Category</th><th>Qty</th><th>Available</th><th>Action</th>
        </tr>
    </thead>
    <tbody id="booksTableBody">
    {% for book in books %}
        <tr
            data-title="{{ book.name|lower }}"
            data-author="{{ book.author|lower }}"
            data-isbn="{{ book.isbn }}"
            data-category="{{ book.category|lower }}">
            <td>{{ book.name }}</td>
            <td>{{ book.author }}</td>
            <td>{{ book.isbn }}</td>
            <td>{{ book.category }}</td>
            <td>{{ book.quantity }}</td>
            <td>{{ book.available_quantity }}</td>
            <td>
                <button
                    class="delete-btn"
                    data-delete-url="{% url 'delete_book' book.id %}"
                    data-book-name="{{ book.name|escapejs }}"
                    onclick="openDeleteModal(this)">
                    Delete
                </button>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
</div>
{% else %}
<p>No books available.</p>
{% endif %}

<!-- DELETE MODAL -->
<div class="modal-overlay" id="deleteModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
        <h3>Confirm Deletion</h3>
        <p id="deleteMessage"></p>
        <form method="post" id="deleteForm">
            {% csrf_token %}
            <button type="button" onclick="closeDeleteModal()">Cancel</button>
            <button type="submit">Delete</button>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
(() => {
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const sortSelect = document.getElementById('sortSelect');
    const grid = document.getElementById('booksGrid');
    const tableBody = document.getElementById('booksTableBody');

    /* ---------- VIEW ---------- */
    window.switchView = view => {
        localStorage.setItem('preferredView', view);
        document.getElementById('booksGrid').style.display = view === 'grid' ? 'grid' : 'none';
        document.getElementById('booksTable').style.display = view === 'list' ? 'block' : 'none';
    };

    document.addEventListener('DOMContentLoaded', () => {
        switchView(localStorage.getItem('preferredView') || 'grid');
        animateCounters();
    });

    /* ---------- FILTER + SORT ---------- */
    function applyFilter() {
        const term = searchInput.value.toLowerCase();
        const cat = categoryFilter.value;
        const sort = sortSelect.value;

        const process = items => {
            const visible = [];
            items.forEach(el => {
                const match =
                    (el.dataset.title.includes(term) ||
                     el.dataset.author.includes(term) ||
                     el.dataset.isbn.includes(term)) &&
                    (!cat || el.dataset.category === cat);
                el.style.display = match ? '' : 'none';
                if (match) visible.push(el);
            });

            if (sort !== 'recent') {
                visible.sort((a,b) =>
                    a.dataset[sort].localeCompare(b.dataset[sort]));
                visible.forEach(el => el.parentNode.appendChild(el));
            }
        };

        if (grid) process([...grid.children]);
        if (tableBody) process([...tableBody.children]);
    }

    searchInput.addEventListener('input', applyFilter);
    categoryFilter.addEventListener('change', applyFilter);
    sortSelect.addEventListener('change', applyFilter);

    /* ---------- DELETE ---------- */
    const modal = document.getElementById('deleteModal');
    const msg = document.getElementById('deleteMessage');
    const form = document.getElementById('deleteForm');

    window.openDeleteModal = btn => {
        msg.textContent = `Delete "${btn.dataset.bookName}" permanently?`;
        form.action = btn.dataset.deleteUrl;
        modal.classList.add('active');
    };

    window.closeDeleteModal = () => modal.classList.remove('active');

    /* ---------- COUNTERS ---------- */
    function animateCounters() {
        document.querySelectorAll('.counter').forEach(c => {
            const target = +c.dataset.target;
            if (!target) return c.textContent = '0';
            let cur = 0;
            const step = target / 60;
            const tick = () => {
                cur += step;
                if (cur < target) {
                    c.textContent = Math.floor(cur);
                    requestAnimationFrame(tick);
                } else c.textContent = target;
            };
            tick();
        });
    }
})();
</script>
{% endblock %}
