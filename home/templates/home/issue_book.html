{% extends 'base.html' %}

{% block title %}Issue Book - Library MS{% endblock %}

{% block content %}
<div class="auth-container stagger-item">
    <h2><i class="fas fa-hand-holding-heart"></i> Issue Book</h2>
    <p style="text-align: center; color: var(--text-muted); margin-bottom: 2rem;">Assign a book to a library member</p>
    
    <div id="bookPreview" style="display: none; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; animation: fadeIn 0.5s ease;">
        <div style="display: flex; gap: 1.5rem; align-items: start;">
            <div id="previewCover" style="width: 100px; height: 140px; background: rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-book fa-2x text-muted"></i>
            </div>
            <div style="flex-grow: 1;">
                <h4 id="previewTitle" style="margin: 0 0 0.5rem 0; color: var(--text-main);"></h4>
                <p id="previewAuthor" style="margin: 0 0 1rem 0; color: var(--text-muted); font-size: 0.9rem;"></p>
                <div id="previewStatus" class="badge"></div>
            </div>
        </div>
    </div>

    <form method="post" id="issueForm">
        {% csrf_token %}
        
        {% for field in form %}
        <div class="form-group {% if field.errors %}has-error{% endif %}">
            <label for="{{ field.id_for_label }}">
                <i class="fas fa-{% if 'book' in field.name %}book{% elif 'student' in field.name or 'member' in field.name %}user{% elif 'date' in field.name %}calendar{% else %}info-circle{% endif %}"></i>
                {{ field.label }}
            </label>
            <div class="input-wrapper">
                <i class="fas fa-{% if 'book' in field.name %}book{% elif 'student' in field.name or 'member' in field.name %}user{% elif 'date' in field.name %}calendar{% else %}info-circle{% endif %} input-icon"></i>
                {% if field.field.widget.input_type == 'select' %}
                    {{ field }}
                {% else %}
                    <input 
                        type="{{ field.field.widget.input_type }}" 
                        id="{{ field.id_for_label }}" 
                        name="{{ field.name }}"
                        {% if field.field.required %}required{% endif %}
                        placeholder="{{ field.label }}"
                        class="{% if field.errors %}error{% endif %}"
                        style="padding-left: 3rem;">
                {% endif %}
            </div>
            {% if field.errors %}
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    {{ field.errors.0 }}
                </div>
            {% endif %}
        </div>
        {% endfor %}
        
        <div style="background: rgba(79, 172, 254, 0.1); border-left: 4px solid #4facfe; padding: 1rem; border-radius: 8px; margin: 1.5rem 0;">
            <p style="color: var(--text-muted); font-size: 0.9rem; margin: 0;">
                <i class="fas fa-info-circle"></i> Make sure the book is available before issuing it to a student.
            </p>
        </div>
        
        <button type="submit" id="issueButton" class="ripple glow">
            <i class="fas fa-hand-holding"></i> Issue Book
        </button>
        
        <div style="text-align: center; margin-top: 1.5rem;">
            <a href="{% url 'index' %}" style="color: var(--text-muted); text-decoration: none; font-size: 0.95rem; transition: color 0.3s;">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </form>
</div>

{% block extra_js %}
<script>
    const form = document.getElementById('issueForm');
    const submitButton = document.getElementById('issueButton');
    const bookSelect = form.querySelector('[name="isbn2"]');
    const bookPreview = document.getElementById('bookPreview');
    const previewTitle = document.getElementById('previewTitle');
    const previewAuthor = document.getElementById('previewAuthor');
    const previewStatus = document.getElementById('previewStatus');
    const previewCover = document.getElementById('previewCover');

    bookSelect.addEventListener('change', function() {
        const isbn = this.value;
        if (!isbn) {
            bookPreview.style.display = 'none';
            return;
        }

        // Fetch book details via search API (filtering by ISBN)
        fetch(`/home/search_books_api/?q=${isbn}`)
            .then(response => response.json())
            .then(data => {
                const book = data.results.find(b => b.isbn === isbn);
                if (book) {
                    previewTitle.textContent = book.name;
                    previewAuthor.textContent = `by ${book.author} | ${book.category}`;
                    
                    if (book.available > 0) {
                        previewStatus.textContent = `${book.available} copies available`;
                        previewStatus.className = 'badge badge-success';
                        previewStatus.style.background = '#10b981';
                    } else {
                        previewStatus.textContent = 'Out of stock';
                        previewStatus.className = 'badge badge-danger';
                        previewStatus.style.background = '#ef4444';
                    }
                    
                    bookPreview.style.display = 'block';
                }
            });
    });

    form.addEventListener('submit', function(e) {
        submitButton.classList.add('loading');
        submitButton.disabled = true;
    });
    
    // Add validation feedback
    const selects = form.querySelectorAll('select');
    const inputs = form.querySelectorAll('input');
    
    [...selects, ...inputs].forEach(element => {
        element.addEventListener('change', function() {
            const formGroup = this.closest('.form-group');
            
            if (this.value) {
                formGroup.classList.remove('has-error');  
                formGroup.classList.add('has-success');
            }
        });
    });
</script>

<style>
    .error-message {
        color: var(--danger);
        font-size: 0.875rem;
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        animation: shake 0.3s ease;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
</style>
{% endblock %}
{% endblock %}
